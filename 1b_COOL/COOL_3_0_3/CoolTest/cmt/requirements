package CoolTest

# Define CMTINSTALLAREA correctly
use LCG_Policy v*

# Basic dependencies as in CoolKernel
use Boost v* LCG_Interfaces
use CORAL v* LCG_Interfaces

#----------------------------------------------------------------------------
# CORAL plugin runtime
#----------------------------------------------------------------------------

use XercesC v* LCG_Interfaces

use oracle v* LCG_Interfaces
use mysql  v* LCG_Interfaces
use sqlite v* LCG_Interfaces
use Frontier_Client v* LCG_Interfaces

# Workaround to set correctly oracle charset (to be put in LCG_Interfaces)
set NLS_LANG american_america.WE8ISO8859P1

# New deployment strategy for tnsnames.ora (CORALCOOL-2756, SPI-758, SPI-726).
# Also workaround for obsolete tnsnames.ora in LHCb cvmfs (CORALCOOL-2164).
set TNS_ADMIN /afs/cern.ch/sw/lcg/app/releases/CORAL/internal/oracle/admin

#----------------------------------------------------------------------------
# Generic test runtime for CORAL and COOL
#----------------------------------------------------------------------------

use CppUnit  v* LCG_Interfaces
use QMtest   v* LCG_Interfaces
use valgrind v* LCG_Interfaces
use igprof   v* LCG_Interfaces
use tcmalloc v* LCG_Interfaces

# Workaround for "failed to start tool 'memcheck'" issue on 32bit platforms?
# See http://daveti.blog.com/2012/08/01/valgrind-dynamic-code-analysis-tool-part-v-valgrind-failed-to-start-tool-memcheck-for-platform/
###set VALGRIND_LIB "$(valgrind_home)/lib/valgrind"

#----------------------------------------------------------------------------
# PyCool runtime
#----------------------------------------------------------------------------

use Python * LCG_Interfaces 
use Reflex * LCG_Interfaces

# Try to drop Reflex dependency of PyCool in ROOT6 (bug #102997)
###macro select_reflex $(select_reflex) ROOT_GE_6_00 "ROOT * LCG_Interfaces"
###use $(select_reflex)

#----------------------------------------------------------------------------
# PyCool runtime with ROOT6 (fix relocability issues)
# See bug #103539, bug #103298 and CORALCOOL-2729
#----------------------------------------------------------------------------

# Fix ROOT_INCLUDE_PATH for local tests within the COOL build directory
# (for release tests '$(COOL_include)' is prepended by LCG_Interfaces/COOL)
path_prepend ROOT_INCLUDE_PATH $(COOL_home)/../$(tag)/include

#----------------------------------------------------------------------------
# ACE runtime
#----------------------------------------------------------------------------

use Qt v* LCG_Interfaces

#----------------------------------------------------------------------------
# More specific test runtime for COOL
#----------------------------------------------------------------------------

path_prepend QMTEST_CLASS_PATH "$(CoolTest_root)/qmtest"

# These are used within qmtest for logging (and configuring tests if needed)
set COOLSYS $(COOL_home)/../$(tag)
set CORALSYS $(CORAL_home)/../$(tag)

# Workaround for bug #40326 in SQLite tests
set CORAL_SQLITE_TEMP_STORE_MEMORY 1

# Select from sys.xxx$ tables in CORAL data dictionary queries
# [done for avalassi, lcg_cool, lcg_cool_nightly even if this env is not set]
###set CORAL_ORA_SELECT_FROM_SYS_TABLES

# Force immediate reload of short-lived cached queries (task #3440)
set FRONTIER_FORCERELOAD short
# Force immediate reload of all queries (workaround for Frontier bug #42465)
###set FRONTIER_FORCERELOAD long

# Useful variables for COOL tests
set COOL_DISABLE_CORALCONNECTIONPOOLCLEANUP 1
set COOL_ENABLE_COOLMSGREPORTER 1
set COOL_MSGLEVEL Error
###set COOL_MSGLEVEL Verbose
###set COOL_QMTEST_SKIPEVOLVE 1

# [NB Signal handlers for qmtest tests are defined in COOLTests.py too]
# Enable the COOL signal handler (disable the ROOT one in this case!)
###set COOL_ENABLE_COOLSIGNALHANDLER 1

# Enable the new algorithm for MV bulk insertion (bug #17903)
# The same value would be used by default if this variable was not set
set COOL_MVINSERTION_PREFETCH_MAXROWS 1000

# Workaround for ORA-01466 on Oracle 11g (bug #89735)
###set COOL_TESTSUITE_SLEEPFOR01466 1

# Bypass tests that are expected to fail with ROOT6 (CORALCOOL-2741)
set COOL_PYCOOLTEST_SKIP_EXCEPTIONS "" ROOT_GE_6_00 1
set COOL_PYCOOLTEST_SKIP_ROOT6927 "" ROOT_GE_6_00 1

#----------------------------------------------------------------------------
# Additional runtime for the COOL nightly tests
# Some settings are different on the various slots
#----------------------------------------------------------------------------

# Configure which tests are run by QMtest using COOL_QMTEST_TARGET
# [Allowed values: ALL, ALL_nomysql, ALL_sqlite]
# Run only SQLite by default (e.g. for test slots and new dev slots)
# Run all backends on the release, dev (preview) and dev1 (patches) slots
# In LCG_Builders/COOL/scripts/COOL_test.sh: 'qmtest run $COOL_QMTEST_TARGET'
set COOL_QMTEST_TARGET  ALL_sqlite \
    lcg_ngt_slt_release ALL \
    lcg_ngt_slt_dev     ALL \
    lcg_ngt_slt_dev1    ALL

#============================================================================
# Private actions and build rules
#============================================================================

private

#----------------------------------------------------------------------------
# Actions and build rules - tests, utilities and examples
#----------------------------------------------------------------------------

# Fake target for tests
action tests "echo No tests in this package"
macro_remove cmt_actions_constituents "tests"

# Fake target for utilities
action utilities "echo No utilities in this package"
macro_remove cmt_actions_constituents "utilities"

# Fake target for examples
action examples "echo No examples in this package"
macro_remove cmt_actions_constituents "examples"

#============================================================================
